<?xml version="1.0"?>
<!--
  ~ Version: 1.0
  ~
  ~ The contents of this file are subject to the OpenVPMS License Version
  ~ 1.0 (the 'License'); you may not use this file except in compliance with
  ~ the License. You may obtain a copy of the License at
  ~ http://www.openvpms.org/license/
  ~
  ~ Software distributed under the License is distributed on an 'AS IS' basis,
  ~ WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License
  ~ for the specific language governing rights and limitations under the
  ~ License.
  ~
  ~ Copyright 2014 (C) OpenVPMS Ltd. All Rights Reserved.
  -->
<!DOCTYPE hibernate-mapping PUBLIC
        "-//Hibernate/Hibernate Mapping DTD 3.0//EN"
        "http://hibernate.sourceforge.net/hibernate-mapping-3.0.dtd">
<hibernate-mapping>


    <query name="act.customerAppointment">
        <![CDATA[
select act.archetypeId, act.id, act.linkId, act.version,
      p.activityStartTime,
      p.activityEndTime,
      indices(details), elements(details),
      act.status,
      act.reason,
      act.description,
      p.archetypeId.shortName,
      p.version,
      e.archetypeId, e.id, e.linkId,
      e.name
from  org.openvpms.component.business.dao.hibernate.im.act.ActDOImpl as act
      join act.participations as p
      join p.entity as e
      join act.participations as schedule
      left outer join act.details as details
where act.archetypeId.shortName = 'act.customerAppointment'
      and p.actShortName = 'act.customerAppointment'
      and ((p.activityStartTime < :from and p.activityEndTime > :from)
	   	or (p.activityStartTime < :to and p.activityEndTime > :to)
      	or (p.activityStartTime >= :from and p.activityEndTime <=:to))
      and schedule.archetypeId.shortName = 'participation.schedule'
          and schedule.entity.id = :scheduleId
          and ((schedule.activityStartTime < :from and schedule.activityEndTime > :from)
            	or (schedule.activityStartTime < :to and schedule.activityEndTime > :to)
            	or (schedule.activityStartTime >= :from and schedule.activityEndTime <=:to))
order by p.activityStartTime, act.id
      ]]>
    </query>

    <query name="act.customerTask">
        <![CDATA[
select act.archetypeId, act.id, act.linkId, act.version,
      p.activityStartTime,
      p.activityEndTime,
      indices(details), elements(details),
      act.status,
      act.reason,
      act.description,
      p.archetypeId.shortName,
      p.version,
      e.archetypeId, e.id, e.linkId,
      e.name
from  org.openvpms.component.business.dao.hibernate.im.act.ActDOImpl as act
      join act.participations as p
      join p.entity as e
      join act.participations as schedule
      left outer join act.details as details
where act.archetypeId.shortName = 'act.customerTask'
      and p.actShortName = 'act.customerTask'
      and (p.activityStartTime <= :to
          and (p.activityEndTime >= :from or p.activityEndTime is null))
      and schedule.archetypeId.shortName = 'participation.worklist'
          and schedule.entity.id = :scheduleId
          and (schedule.activityStartTime <= :to
              and (schedule.activityEndTime >= :from
                   or schedule.activityEndTime is null))
order by p.activityStartTime, act.id
      ]]>
    </query>

    <query name="findFreeSlots">
        <![CDATA[
select ap.entity.id as scheduleId, a.activityEndTime as startTime, min(b.activityStartTime) as endTime
from  org.openvpms.component.business.dao.hibernate.im.act.ActDOImpl as a,
      org.openvpms.component.business.dao.hibernate.im.act.ActDOImpl as b
join a.participations ap with ap.archetypeId.shortName = 'participation.schedule' and ap.entity.id in (:scheduleIds)
join b.participations bp with bp.archetypeId.shortName = 'participation.schedule'
where a.archetypeId.shortName = 'act.customerAppointment'
      and b.archetypeId.shortName = 'act.customerAppointment'
      and (a.activityStartTime between :from and :to or a.activityEndTime between :from and :to)
      and (b.activityStartTime between :from and :to or b.activityEndTime between :from and :to)
      and a.activityEndTime <= b.activityStartTime
      and bp.entity.id = ap.entity.id
group by a.activityEndTime
having a.activityEndTime < min(b.activityStartTime)
order by a.activityEndTime, ap.entity.id
        ]]>
    </query>

    <query name="findFreeSlots2">
        <![CDATA[
select a.activityEndTime as start_time, min(b.activityStartTime) as end_time
from  org.openvpms.component.business.dao.hibernate.im.act.ActDOImpl as a,
      org.openvpms.component.business.dao.hibernate.im.act.ActDOImpl as b
join a.participations ap with ap.archetypeId.shortName = 'participation.schedule' and ap.entity.id = :scheduleId
join b.participations bp with bp.archetypeId.shortName = 'participation.schedule' and bp.entity.id = :scheduleId
where a.archetypeId.shortName = 'act.customerAppointment'
      and b.archetypeId.shortName = 'act.customerAppointment'
      and (a.activityStartTime between :from and :to or a.activityEndTime between :from and :to)
      and (b.activityStartTime between :from and :to or b.activityEndTime between :from and :to)
      and a.activityEndTime <= b.activityStartTime
group by a.activityEndTime
having a.activityEndTime < min(b.activityStartTime)
        ]]>
    </query>


</hibernate-mapping>