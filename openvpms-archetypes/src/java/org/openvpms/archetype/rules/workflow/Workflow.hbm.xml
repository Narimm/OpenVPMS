<?xml version="1.0"?>
<!--
  #  Version: 1.0
  #
  #  The contents of this file are subject to the OpenVPMS License Version
  #  1.0 (the 'License'); you may not use this file except in compliance with
  #  the License. You may obtain a copy of the License at
  #  http://www.openvpms.org/license/
  #
  #  Software distributed under the License is distributed on an 'AS IS' basis,
  #  WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License
  #  for the specific language governing rights and limitations under the
  #  License.
  #
  #  Copyright 2006 (C) OpenVPMS Ltd. All Rights Reserved.
  #
  #  $Id$
-->
<!DOCTYPE hibernate-mapping PUBLIC
        "-//Hibernate/Hibernate Mapping DTD 3.0//EN"
        "http://hibernate.sourceforge.net/hibernate-mapping-3.0.dtd">
<hibernate-mapping>


    <query name="act.customerAppointment">
        <![CDATA[
select act.archetypeId, act.id, act.linkId,
      p.activityStartTime,
      p.activityEndTime,
      indices(details), elements(details),
      act.status,
      act.reason,
      act.description,
      e.archetypeId, e.id, e.linkId,
      e.name
from  org.openvpms.component.business.dao.hibernate.im.act.ActDOImpl as act,
      org.openvpms.component.business.dao.hibernate.im.act.ParticipationDOImpl as p,
      org.openvpms.component.business.dao.hibernate.im.entity.EntityDOImpl as e
left outer join act.details as details
where p.act = act
      and p.entity = e
      and act.archetypeId.shortName = 'act.customerAppointment'
      and p.actShortName = 'act.customerAppointment'
      and ((p.activityStartTime < :from and p.activityEndTime > :from)
	   	or (p.activityStartTime < :to and p.activityEndTime > :to)
      	or (p.activityStartTime >= :from and p.activityEndTime <=:to))
      and act in (
            select distinct act
            from org.openvpms.component.business.dao.hibernate.im.act.ActDOImpl as act,
           org.openvpms.component.business.dao.hibernate.im.act.ParticipationDOImpl as p
      where act.archetypeId.shortName = 'act.customerAppointment'
            and p.actShortName = 'act.customerAppointment'
            and p.archetypeId.shortName = 'participation.schedule'
            and act = p.act
            and p.entity.id = :scheduleId
            and ((p.activityStartTime < :from and p.activityEndTime > :from)
            	or (p.activityStartTime < :to and p.activityEndTime > :to)
            	or (p.activityStartTime >= :from and p.activityEndTime <=:to)))
order by p.activityStartTime, act.id
      ]]>
    </query>

    <query name="act.customerAppointment-incomplete">
        <![CDATA[
select act.archetypeId, act.id, act.linkId,
      p.activityStartTime,
      p.activityEndTime,
      indices(details), elements(details),
      act.status,
      act.reason,
      act.description,
      e.archetypeId, e.id, e.linkId,
      e.name
from  org.openvpms.component.business.dao.hibernate.im.act.ActDOImpl as act,
      org.openvpms.component.business.dao.hibernate.im.act.ParticipationDOImpl as p,
      org.openvpms.component.business.dao.hibernate.im.entity.EntityDOImpl as e
left outer join act.details as details
where p.act = act
      and p.entity = e
      and act.archetypeId.shortName = 'act.customerAppointment'
      and p.actShortName = 'act.customerAppointment'
      and ((p.activityStartTime < :from and p.activityEndTime > :from)
      	or (p.activityStartTime < :to and p.activityEndTime > :to)
      	or (p.activityStartTime >= :from and p.activityEndTime <=:to))
      and act in (
            select distinct act
            from org.openvpms.component.business.dao.hibernate.im.act.ActDOImpl as act,
           org.openvpms.component.business.dao.hibernate.im.act.ParticipationDOImpl as p
      where act.archetypeId.shortName = 'act.customerAppointment'
            and p.actShortName = 'act.customerAppointment'
            and p.archetypeId.shortName = 'participation.schedule'
            and act = p.act
            and p.entity.id = :scheduleId
            and ((p.activityStartTime < :from and p.activityEndTime > :from)
            	or (p.activityStartTime < :to and p.activityEndTime > :to)
            	or (p.activityStartTime >= :from and p.activityEndTime <=:to))
            and not (act.status = 'COMPLETED' or act.status='CANCELLED'))
order by p.activityStartTime, act.id
      ]]>
    </query>

    <query name="act.customerAppointment-complete">
        <![CDATA[
select act.archetypeId, act.id, act.linkId,
      p.activityStartTime,
      p.activityEndTime,
      indices(details), elements(details),
      act.status,
      act.reason,
      act.description,
      e.archetypeId, e.id, e.linkId,
      e.name
from  org.openvpms.component.business.dao.hibernate.im.act.ActDOImpl as act,
      org.openvpms.component.business.dao.hibernate.im.act.ParticipationDOImpl as p,
      org.openvpms.component.business.dao.hibernate.im.entity.EntityDOImpl as e
left outer join act.details as details
where p.act = act
      and p.entity = e
      and act.archetypeId.shortName = 'act.customerAppointment'
      and p.actShortName = 'act.customerAppointment'
      and ((p.activityStartTime < :from and p.activityEndTime > :from)
      	or (p.activityStartTime < :to and p.activityEndTime > :to)
      	or (p.activityStartTime >= :from and p.activityEndTime <=:to))
      and act in (
            select distinct act
            from org.openvpms.component.business.dao.hibernate.im.act.ActDOImpl as act,
           org.openvpms.component.business.dao.hibernate.im.act.ParticipationDOImpl as p
      where act.archetypeId.shortName = 'act.customerAppointment'
            and p.actShortName = 'act.customerAppointment'
            and p.archetypeId.shortName = 'participation.schedule'
            and act = p.act
            and p.entity.id = :scheduleId
            and ((p.activityStartTime < :from and p.activityEndTime > :from)
            	or (p.activityStartTime < :to and p.activityEndTime > :to)
            	or (p.activityStartTime >= :from and p.activityEndTime <=:to))
            and (act.status = 'COMPLETED' or act.status='CANCELLED'))
order by p.activityStartTime, act.id
      ]]>
    </query>

    <query name="act.customerAppointment-clinician">
        <![CDATA[
select act.archetypeId, act.id, act.linkId,
      p.activityStartTime,
      p.activityEndTime,
      indices(details), elements(details),
      act.status,
      act.reason,
      act.description,
      e.archetypeId, e.id, e.linkId,
      e.name
from  org.openvpms.component.business.dao.hibernate.im.act.ActDOImpl as act,
      org.openvpms.component.business.dao.hibernate.im.act.ParticipationDOImpl as p,
      org.openvpms.component.business.dao.hibernate.im.entity.EntityDOImpl as e
left outer join act.details as details
where p.act = act
      and p.entity = e
      and act.archetypeId.shortName = 'act.customerAppointment'
      and p.actShortName = 'act.customerAppointment'
      and ((p.activityStartTime < :from and p.activityEndTime > :from)
      	or (p.activityStartTime < :to and p.activityEndTime > :to)
      	or (p.activityStartTime >= :from and p.activityEndTime <=:to))
      and act in (
            select distinct act
            from org.openvpms.component.business.dao.hibernate.im.act.ActDOImpl as act,
           org.openvpms.component.business.dao.hibernate.im.act.ParticipationDOImpl as pschedule,
           org.openvpms.component.business.dao.hibernate.im.act.ParticipationDOImpl as pclinician
      where act.archetypeId.shortName = 'act.customerAppointment'
            and p.actShortName = 'act.customerAppointment'
            and pschedule.archetypeId.shortName = 'participation.schedule'
            and act = pschedule.act
            and pschedule.entity.id = :scheduleId
            and pclinician.archetypeId.shortName = 'participation.clinician'
            and act = pclinician.act
            and pclinician.entity.id = :clinicianId
            and ((p.activityStartTime < :from and p.activityEndTime > :from)
            	or (p.activityStartTime < :to and p.activityEndTime > :to)
            	or (p.activityStartTime >= :from and p.activityEndTime <=:to)))
order by p.activityStartTime, act.id
      ]]>
    </query>

    <query name="act.customerAppointment-clinician-incomplete">
        <![CDATA[
select act.archetypeId, act.id, act.linkId,
      p.activityStartTime,
      p.activityEndTime,
      indices(details), elements(details),
      act.status,
      act.reason,
      act.description,
      e.archetypeId, e.id, e.linkId,
      e.name
from  org.openvpms.component.business.dao.hibernate.im.act.ActDOImpl as act,
      org.openvpms.component.business.dao.hibernate.im.act.ParticipationDOImpl as p,
      org.openvpms.component.business.dao.hibernate.im.entity.EntityDOImpl as e
left outer join act.details as details
where p.act = act
      and p.entity = e
      and act.archetypeId.shortName = 'act.customerAppointment'
      and p.actShortName = 'act.customerAppointment'
      and ((p.activityStartTime < :from and p.activityEndTime > :from)
      	or (p.activityStartTime < :to and p.activityEndTime > :to)
      	or (p.activityStartTime >= :from and p.activityEndTime <=:to))
      and act in (
            select distinct act
            from org.openvpms.component.business.dao.hibernate.im.act.ActDOImpl as act,
           org.openvpms.component.business.dao.hibernate.im.act.ParticipationDOImpl as pschedule,
           org.openvpms.component.business.dao.hibernate.im.act.ParticipationDOImpl as pclinician
      where act.archetypeId.shortName = 'act.customerAppointment'
            and p.actShortName = 'act.customerAppointment'
            and pschedule.archetypeId.shortName = 'participation.schedule'
            and act = pschedule.act
            and pschedule.entity.id = :scheduleId
            and pclinician.archetypeId.shortName = 'participation.clinician'
            and act = pclinician.act
            and pclinician.entity.id = :clinicianId
            and ((p.activityStartTime < :from and p.activityEndTime > :from)
            	or (p.activityStartTime < :to and p.activityEndTime > :to)
            	or (p.activityStartTime >= :from and p.activityEndTime <=:to))
            and not (act.status = 'COMPLETED' or act.status='CANCELLED'))
order by p.activityStartTime, act.id
      ]]>
    </query>

    <query name="act.customerAppointment-clinician-complete">
        <![CDATA[
select act.archetypeId, act.id, act.linkId,
      p.activityStartTime,
      p.activityEndTime,
      indices(details), elements(details),
      act.status,
      act.reason,
      act.description,
      e.archetypeId, e.id, e.linkId,
      e.name
from  org.openvpms.component.business.dao.hibernate.im.act.ActDOImpl as act,
      org.openvpms.component.business.dao.hibernate.im.act.ParticipationDOImpl as p,
      org.openvpms.component.business.dao.hibernate.im.entity.EntityDOImpl as e
left outer join act.details as details
where p.act= act
      and p.entity = e
      and act.archetypeId.shortName = 'act.customerAppointment'
      and p.actShortName = 'act.customerAppointment'
      and ((p.activityStartTime < :from and p.activityEndTime > :from)
      	or (p.activityStartTime < :to and p.activityEndTime > :to)
      	or (p.activityStartTime >= :from and p.activityEndTime <=:to))
      and act in (
            select distinct act
            from org.openvpms.component.business.dao.hibernate.im.act.ActDOImpl as act,
           org.openvpms.component.business.dao.hibernate.im.act.ParticipationDOImpl as pschedule,
           org.openvpms.component.business.dao.hibernate.im.act.ParticipationDOImpl as pclinician
      where act.archetypeId.shortName = 'act.customerAppointment'
            and p.actShortName = 'act.customerAppointment'
            and pschedule.archetypeId.shortName = 'participation.schedule'
            and act = pschedule.act
            and pschedule.entity.id = :scheduleId
            and pclinician.archetypeId.shortName = 'participation.clinician'
            and act.linkId = pclinician.act.linkId
            and pclinician.entity.id = :clinicianId
            and ((p.activityStartTime < :from and p.activityEndTime > :from)
            	or (p.activityStartTime < :to and p.activityEndTime > :to)
            	or (p.activityStartTime >= :from and p.activityEndTime <=:to))
            and (act.status = 'COMPLETED' or act.status='CANCELLED'))
order by p.activityStartTime, act.id
      ]]>
    </query>

    <query name="act.customerAppointment-overlap">
        <![CDATA[
select act.id
from  org.openvpms.component.business.dao.hibernate.im.act.ActDOImpl as act,
      org.openvpms.component.business.dao.hibernate.im.act.ParticipationDOImpl as p
where act.archetypeId.shortName = 'act.customerAppointment'
      and p.actShortName = 'act.customerAppointment'
      and act.id <> :actId
      and act = p.act
      and p.entity.id = :scheduleId
      and act.active = 1
      and ((p.activityStartTime < :startTime and p.activityEndTime > :startTime)
           or (p.activityStartTime < :endTime and  p.activityEndTime > :endTime)
           or (p.activityStartTime >= :startTime and p.activityEndTime <= :endTime))
      ]]>
    </query>

    <query name="act.customerAppointment-overlapNew">
        <![CDATA[
select act.id
from  org.openvpms.component.business.dao.hibernate.im.act.ActDOImpl as act,
      org.openvpms.component.business.dao.hibernate.im.act.ParticipationDOImpl as p
where act.archetypeId.shortName = 'act.customerAppointment'
      and p.actShortName = 'act.customerAppointment'
      and act = p.act
      and p.entity.id = :scheduleId
      and act.active = 1
      and ((p.activityStartTime < :startTime and p.activityEndTime > :startTime)
           or (p.activityStartTime < :endTime and  p.activityEndTime > :endTime)
           or (p.activityStartTime >= :startTime and p.activityEndTime <= :endTime))
      ]]>
    </query>

</hibernate-mapping>