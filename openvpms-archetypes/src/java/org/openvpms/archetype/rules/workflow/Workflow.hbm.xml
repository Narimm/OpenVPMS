<?xml version="1.0"?>
<!--
  #  Version: 1.0
  #
  #  The contents of this file are subject to the OpenVPMS License Version
  #  1.0 (the 'License'); you may not use this file except in compliance with
  #  the License. You may obtain a copy of the License at
  #  http://www.openvpms.org/license/
  #
  #  Software distributed under the License is distributed on an 'AS IS' basis,
  #  WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License
  #  for the specific language governing rights and limitations under the
  #  License.
  #
  #  Copyright 2006 (C) OpenVPMS Ltd. All Rights Reserved.
  #
  #  $Id$
-->
<!DOCTYPE hibernate-mapping PUBLIC
        "-//Hibernate/Hibernate Mapping DTD 3.0//EN"
        "http://hibernate.sourceforge.net/hibernate-mapping-3.0.dtd">
<hibernate-mapping>


    <query name="act.customerAppointment">
        <![CDATA[
select p.act,
      act.activityStartTime,
      act.activityEndTime,
      act.status,
      act.reason,
      act.description,
      p.entity,
      e.name
from  org.openvpms.component.business.domain.im.act.Act as act,
      org.openvpms.component.business.domain.im.common.Participation as p,
      org.openvpms.component.business.domain.im.common.Entity as e
where p.act.linkId = act.linkId
      and p.entity.linkId = e.linkId
      and act.archetypeId.entityName = 'act'
      and act.archetypeId.concept = 'customerAppointment'
      and act.activityStartTime between :from and :to
      and act.linkId in (
            select distinct act.linkId
            from org.openvpms.component.business.domain.im.act.Act as act,
           org.openvpms.component.business.domain.im.common.Participation as p
      where act.archetypeId.entityName = 'act'
            and act.archetypeId.concept = 'customerAppointment'
            and p.archetypeId.entityName = 'participation'
            and p.archetypeId.concept = 'schedule'
            and act.linkId = p.act.linkId
            and p.entity.linkId = :scheduleId
            and act.activityStartTime between :from and :to)
order by act.activityStartTime, act.linkId
      ]]>
    </query>

    <!--query name="act.customerAppointment4">
        <![CDATA[
select act.activityStartTime,
     act.activityEndTime,
     ppatient.entity,
     pcustomer.entity,
     act.status,
     act.reason,
     act.description
from org.openvpms.component.business.domain.im.act.Act as act
     inner join act.participations as schedule
     left outer join act.participations as ppatient
                with (ppatient.archetypeId.entityName = 'party'
                      and ppatient.archetypeId.concept = 'patientpet')
     left outer join act.participations as pcustomer
     with (pcustomer.archetypeId.entityName = 'participation'
           and pcustomer.archetypeId.concept = 'customer')
     left outer join org.openvpms.component.business.domain.im.party.Party as patient
     with (patient.archetypeId.entityName = 'party' and patient.archetypeId.concept='patientpet')
          and patient.linkId = ppatient.entity.linkId
     left outer join org.openvpms.component.business.domain.im.party.Party as customer
     with (customer.archetypeId.entityName = 'party' and customer.archetypeId.concept='customerperson')
     and customer.linkId = pcustomer.entity.linkId
where ((act.archetypeId.entityName = 'act' and act.archetypeId.concept = 'customerAppointment')
    and (schedule.archetypeId.entityName = 'participation' and schedule.archetypeId.concept = 'schedule')
    and schedule.entity.linkId = :scheduleId)
      ]]>
    </query-->

    <query name="act.customerAppointment3">
        <![CDATA[
        select a, pCust.entity, customer.name, pPat.entity, patient.name
        from   org.openvpms.component.business.domain.im.act.Act as a,
               org.openvpms.component.business.domain.im.common.Participation as p,
               org.openvpms.component.business.domain.im.party.Party as customer,
               org.openvpms.component.business.domain.im.common.Participation as pCust,
               org.openvpms.component.business.domain.im.party.Party as patient,
               org.openvpms.component.business.domain.im.common.Participation as pPat
        where  a.archetypeId.entityName = 'act' and
               a.archetypeId.concept='customerAppointment' and
               a.active=1 and
               a.activityStartTime between :from and :to and
               a.linkId = p.act.linkId and
               p.archetypeId.entityName='participation' and
               p.archetypeId.concept='schedule' and
               p.active=1 and
               p.entity.linkId=:scheduleLinkId and
               a.linkId = pCust.act.linkId and
               pCust.archetypeId.concept='customer' and
               pCust.entity.linkId = customer.linkId and
               a.linkId = pPat.act.linkId and
               pPat.archetypeId.concept='patient' and
               pPat.entity.linkId = patient.linkId
        order by a.activityStartTime
      ]]>
    </query>

    <query name="act.customerAppointment2">
        <![CDATA[
        select a, customer, patient
        from   org.openvpms.component.business.domain.im.act.Act as a,
               org.openvpms.component.business.domain.im.common.Participation as p,
               org.openvpms.component.business.domain.im.party.Party as customer,
               org.openvpms.component.business.domain.im.common.Participation as pCust,
               org.openvpms.component.business.domain.im.party.Party as patient,
               org.openvpms.component.business.domain.im.common.Participation as pPat
        where  a.archetypeId.entityName = 'act' and
               a.archetypeId.concept='customerAppointment' and
               a.active=1 and
               a.activityStartTime between :from and :to and
               a.linkId = p.act.linkId and
               p.archetypeId.entityName='participation' and
               p.archetypeId.concept='schedule' and
               p.active=1 and
               p.entity.linkId=:scheduleLinkId and
               a.linkId = pCust.act.linkId and
               pCust.archetypeId.concept='customer' and
               pCust.entity.linkId = customer.linkId and
               a.linkId = pPat.act.linkId and
               pPat.archetypeId.concept='patient' and
               pPat.entity.linkId = patient.linkId
        order by a.activityStartTime
      ]]>
    </query>

    <query name="act.customerAppointment5">
        <![CDATA[
        select distinct act
        from   org.openvpms.component.business.domain.im.act.Act as act
               left outer join fetch act.participations participations
        where  act.linkId in
               (select a.linkId
                from  org.openvpms.component.business.domain.im.act.Act a,
                      org.openvpms.component.business.domain.im.common.Participation p
                where a.archetypeId.entityName = 'act' and
                      a.archetypeId.concept='customerAppointment' and
                      a.active=1 and
                      a.activityStartTime between :from and :to and
                      a.linkId = p.act.linkId and
                      p.archetypeId.entityName='participation' and
                      p.archetypeId.concept='schedule' and
                      p.active=1 and
                      p.entity.linkId=:scheduleLinkId)
        order by act.activityStartTime
      ]]>
    </query>

</hibernate-mapping>