<project default="openvpms:dist"
         xmlns:ant="jelly:ant"
         xmlns:maven="jelly:maven"
         xmlns:deploy="deploy"
         xmlns:j="jelly:core">

    <goal name="openvpms:dist" prereqs="openvpms:dist-prepare-bin-filesystem">
        <zip zipfile="${maven.dist.dir}/${maven.final.name}.zip">
            <zipfileset dir="${maven.dist.bin.archive.dir}"/>
        </zip>
    </goal>

    <goal name="openvpms:dist-prepare-bin-filesystem"
          prereqs="dist:build-setup, openvpms:createdb">
        <!--

        This is the directory where everything is copied to so that it can
        be archived.

        -->

        <ant:delete dir="${maven.dist.bin.assembly.dir}"/>
        <ant:mkdir dir="${maven.dist.bin.assembly.dir}"/>

        <j:set var="distDir" value="${maven.dist.bin.assembly.dir}"/>

        <!-- copy scripts -->
        <mkdir dir="${distDir}/bin"/>
        <copy todir="${distDir}/bin">
            <fileset dir="${basedir}/src/bin"/>
        </copy>

        <!-- Ensure scripts, batch files have appropriate end-of-line chars -->
        <fixcrlf srcDir="${distDir}" eol="lf">
            <include name="**/*.sh"/>
        </fixcrlf>

        <fixcrlf srcDir="${distDir}" eol="crlf">
            <include name="**/*.bat"/>
        </fixcrlf>

        <!-- copy the dependencies -->
        <deploy:copy-deps todir="${distDir}/lib"/>

        <!-- move the webapp -->
        <mkdir dir="${distDir}/webapps"/>
        <move file="${distDir}/lib/openvpms-${pom.currentVersion}.war"
              tofile="${distDir}/webapps/openvpms.war"/>

        <!-- copy the configuration files -->
        <mkdir dir="${distDir}/conf"/>
        <copy todir="${distDir}/conf"
              file="${maven.hibernate.properties}"/>
        <copy todir="${distDir}/conf"
              file="${basedir}/src/conf/log4j/log4j.properties"/>
        <copy todir="${distDir}/conf"
              file="${basedir}/src/conf/spring/applicationContext.xml"/>

        <!--  copy the report templates -->
        <mkdir dir="${distDir}/reports"/>
        <copy todir="${distDir}/reports">
            <fileset dir="${basedir}/src/reports"/>
        </copy>

        <!-- copy the import data -->
        <mkdir dir="${distDir}/import/data"/>
        <copy todir="${distDir}/import/data">
            <fileset dir="${basedir}/src/import/data"/>
        </copy>

        <!-- rename the kettle plugin -->
        <mkdir dir="${distDir}/import/plugin"/>
        <move file="${distDir}/lib/openvpms-etl-plugin-${pom.currentVersion}.zip"
              tofile="${distDir}/import/plugin/OpenVPMSLoader.zip"/>

        <!--  copy the import templates -->
        <mkdir dir="${distDir}/import/transforms"/>
        <copy todir="${distDir}/import/transforms">
            <fileset dir="${basedir}/src/import/transforms"/>
        </copy>

        <!-- copy the database scripts -->
        <mkdir dir="${distDir}/db"/>
        <copy todir="${distDir}/db" file="${basedir}/src/db/createdb.sql"/>
        <copy todir="${distDir}/db" file="${maven.build.dir}/db/db.sql"/>

        <!-- copy the update scripts etc -->
        <mkdir dir="${distDir}/update"/>
        <copy todir="${distDir}/update">
            <fileset dir="${basedir}/src/update"/>
        </copy>

        <!-- copy the archetypes -->
        <mkdir dir="${distDir}/update/archetypes"/>
        <copy todir="${distDir}/update/archetypes">
            <fileset dir="${maven.build.dir}/archetypes"/>
        </copy>
    </goal>

    <goal name="openvpms:createdb">
        <attainGoal name="hibernate:schema-export"/>
        <attainGoal name="archetype:load"/>
        <attainGoal name="report:load"/>
        <attainGoal name="openvpms:dumpdb"/>
    </goal>

    <!-- ================================================================== -->
    <!-- Archetype targets                                                  -->
    <!-- ================================================================== -->
    <goal name="archetype:load"
          description="Load the Archetypes from a directory">
        <attainGoal name="extract-archetype-files"/>
        <ant:java
                classname="org.openvpms.tools.archetype.loader.ArchetypeLoader"
                failonerror="true"
                fork="true">
            <ant:classpath>
                <ant:pathelement path="${basedir}/src/conf/log4j"/>
                <ant:pathelement path="${maven.build.dest}"/>
                <ant:pathelement path="${maven.build.dir}/hibernate"/>
                <ant:path refid="maven.dependency.classpath"/>
            </ant:classpath>
            <arg line="${openvpms.archetype.loader.cmdline}"/>
        </ant:java>
    </goal>

    <goal name="extract-archetype-files">
        <mkdir dir="${maven.build.dir}/archetypes"/>
        <delete>
            <fileset dir="${maven.build.dir}/archetypes" includes="**/*.adl"/>
        </delete>

        <j:set var="repo" value="${context.getVariable('maven.repo.local')}"/>
        <j:set var="dependencyId" value="org.openvpms:openvpms-archetypes"/>
        <j:set var="artifactPath"
               value="${pom.getDependencyPath(dependencyId)}"/>
        <j:set var="artifactRepoPath" value="${repo}/${artifactPath}"/>

        <unzip src="${artifactPath}" dest="${maven.build.dir}/archetypes">
            <patternset>
                <include name="**/*.adl"/>
                <include name="**/*.xml"/>
            </patternset>
        </unzip>
    </goal>

    <!-- ================================================================== -->
    <!-- Report loading                                                     -->
    <!-- ================================================================== -->
    <goal name="report:load" description="Load the reports from a directory">
        <ant:java classname="org.openvpms.report.tools.TemplateLoader"
                  failonerror="true"
                  fork="true">
            <ant:classpath>
                <ant:pathelement path="${basedir}/src/conf/log4j"/>
                <ant:pathelement path="${maven.build.dir}/hibernate"/>
                <ant:pathelement path="${basedir}/src/conf/spring"/>
                <ant:pathelement path="${maven.build.dest}"/>
                <ant:path refid="maven.dependency.classpath"/>
            </ant:classpath>
            <arg line="${openvpms.report.loader.cmdline}"/>
        </ant:java>
    </goal>

    <!-- ================================================================== -->
    <!-- Schema targets                                                     -->
    <!-- ================================================================== -->
    <goal name="openvpms:dumpdb">
        <mkdir dir="${maven.build.dir}/db"/>
        <exec executable="mysqldump" output="${maven.build.dir}/db/db.sql"
              failOnError="true" logError="true">
            <arg line="${openvpms.db.name} -u ${openvpms.db.user} --password=${openvpms.db.password}"/>
        </exec>
    </goal>

    <preGoal name="hibernate:schema-export">
        <attainGoal name="generate-hibernate-properties"/>
        <attainGoal name="extract-mapping-files"/>
    </preGoal>

    <goal name="generate-hibernate-properties">
        <copy tofile="${maven.hibernate.properties}"
              file="src/conf/hibernate/hibernate.properties">
            <filterset>
                <filter token="HIBERNATE_DIALECT" value="${hibernate.dialect}"/>
                <filter token="JDBC_DRIVER"
                        value="${hibernate.connection.driver_class}"/>
                <filter token="JDBC_URL" value="${hibernate.connection.url}"/>
                <filter token="JDBC_USERNAME"
                        value="${hibernate.connection.username}"/>
                <filter token="JDBC_PASSWORD"
                        value="${hibernate.connection.password}"/>
            </filterset>
        </copy>
    </goal>

    <goal name="extract-mapping-files">
        <delete>
            <fileset dir="${maven.build.dir}/hibernate"
                     includes="**/*.hbm.xml"/>
        </delete>

        <j:set var="repo" value="${context.getVariable('maven.repo.local')}"/>
        <j:set var="dependencyId" value="org.openvpms:openvpms-framework"/>
        <j:set var="artifactPath"
               value="${pom.getDependencyPath(dependencyId)}"/>
        <j:set var="artifactRepoPath" value="${repo}/${artifactPath}"/>

        <unzip src="${artifactPath}" dest="${maven.hibernate.input.dir}">
            <patternset>
                <include name="**/*.hbm.xml"/>
            </patternset>
        </unzip>

        <j:set var="dependencyId" value="org.openvpms:openvpms-etl"/>
        <j:set var="artifactPath"
               value="${pom.getDependencyPath(dependencyId)}"/>
        <j:set var="artifactRepoPath" value="${repo}/${artifactPath}"/>

        <unzip src="${artifactPath}" dest="${maven.hibernate.input.dir}">
            <patternset>
                <include name="**/*.hbm.xml"/>
            </patternset>
        </unzip>

    </goal>

</project>