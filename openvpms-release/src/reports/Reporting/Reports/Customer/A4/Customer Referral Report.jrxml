<?xml version="1.0" encoding="UTF-8"?>
<!--
  ~ Version: 1.0
  ~
  ~ The contents of this file are subject to the OpenVPMS License Version
  ~ 1.0 (the 'License'); you may not use this file except in compliance with
  ~ the License. You may obtain a copy of the License at
  ~ http://www.openvpms.org/license/
  ~
  ~ Software distributed under the License is distributed on an 'AS IS' basis,
  ~ WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License
  ~ for the specific language governing rights and limitations under the
  ~ License.
  ~
  ~ Copyright 2015 (C) OpenVPMS Ltd. All Rights Reserved.
  -->

<!-- Created with Jaspersoft Studio version 6.0.4.final using JasperReports Library version 6.0.4  -->
<!-- 2015-06-15T05:49:00 -->
<jasperReport xmlns="http://jasperreports.sourceforge.net/jasperreports"
              xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
              xsi:schemaLocation="http://jasperreports.sourceforge.net/jasperreports http://jasperreports.sourceforge.net/xsd/jasperreport.xsd"
              name="Customer Referral Report" pageWidth="595" pageHeight="842" columnWidth="535" leftMargin="30"
              rightMargin="30" topMargin="20" bottomMargin="20" uuid="7226e7a4-b249-48c1-99a3-36fc7ab7781d">
    <property name="ireport.scriptlethandling" value="0"/>
    <property name="ireport.encoding" value="UTF-8"/>
    <property name="ireport.zoom" value="1.0"/>
    <property name="ireport.x" value="0"/>
    <property name="ireport.y" value="0"/>
    <property name="com.jaspersoft.studio.data.defaultdataadapter" value="OpenVPMS Local"/>
    <import value="net.sf.jasperreports.engine.*"/>
    <import value="java.util.*"/>
    <import value="net.sf.jasperreports.engine.data.*"/>
    <parameter name="IsEmail" class="java.lang.Boolean" isForPrompting="false">
        <parameterDescription>
            <![CDATA[If true, indicates the report is being emailed, to enable different formatting]]></parameterDescription>
        <defaultValueExpression><![CDATA[Boolean.FALSE]]></defaultValueExpression>
    </parameter>
    <parameter name="omitNone" class="java.lang.Boolean">
        <parameterDescription><![CDATA[Omit if no Referred By ?]]></parameterDescription>
        <defaultValueExpression><![CDATA[new Boolean("false")]]></defaultValueExpression>
    </parameter>
    <parameter name="Explain" class="java.lang.Boolean">
        <parameterDescription><![CDATA[Display explanation ?]]></parameterDescription>
        <defaultValueExpression><![CDATA[false]]></defaultValueExpression>
    </parameter>
    <queryString language="SQL">
        <![CDATA[select replace(ifnull(d.value ,"NONE"),"_"," ") as Referral, count(e.name) as total
from entities e left join entity_details d on e.entity_id = d.entity_id and d.name ="referral"
where
e.arch_short_name like 'party.customer%'
and ((isnull(d.value) = false) or ((isnull(d.value) = true) and  ($P{omitNone} = false)))
group by d.value]]>
    </queryString>
    <field name="Referral" class="java.lang.String"/>
    <field name="total" class="java.lang.Long"/>
    <variable name="TOTAL_CUSTOMERS" class="java.lang.Long" calculation="Sum">
        <variableExpression><![CDATA[$F{total}]]></variableExpression>
    </variable>
    <background>
        <band splitType="Stretch"/>
    </background>
    <title>
        <band splitType="Stretch"/>
    </title>
    <pageHeader>
        <band height="68" splitType="Stretch">
            <staticText>
                <reportElement key="staticText-1" x="140" y="0" width="250" height="24"
                               uuid="c7957bb0-3fb8-4fdb-ba24-3f6c3c9c526b"/>
                <box>
                    <topPen lineWidth="0.0" lineStyle="Solid" lineColor="#000000"/>
                    <leftPen lineWidth="0.0" lineStyle="Solid" lineColor="#000000"/>
                    <bottomPen lineWidth="0.0" lineColor="#000000"/>
                    <rightPen lineWidth="0.0" lineStyle="Solid" lineColor="#000000"/>
                </box>
                <textElement textAlignment="Center">
                    <font size="18" isBold="true" isUnderline="true"/>
                    <paragraph lineSpacing="Single"/>
                </textElement>
                <text><![CDATA[Customer Referral Report]]></text>
            </staticText>
            <textField pattern="">
                <reportElement x="435" y="0" width="100" height="11" uuid="d200db1f-1140-4bbf-b3d1-6f04d4f932eb"/>
                <textElement textAlignment="Right">
                    <font fontName="SansSerif" size="8"/>
                    <paragraph lineSpacing="Single"/>
                </textElement>
                <textFieldExpression>
                    <![CDATA[DateFormat.getDateTimeInstance(DateFormat.SHORT,DateFormat.SHORT, $P{REPORT_LOCALE}).format(new Date())]]></textFieldExpression>
            </textField>
            <textField isBlankWhenNull="false">
                <reportElement key="textField" x="458" y="40" width="27" height="18"
                               uuid="93ce70b6-528e-4a34-972e-487d15223115"/>
                <box>
                    <topPen lineWidth="0.0" lineStyle="Solid" lineColor="#000000"/>
                    <leftPen lineWidth="0.0" lineStyle="Solid" lineColor="#000000"/>
                    <bottomPen lineWidth="0.0" lineColor="#000000"/>
                    <rightPen lineWidth="0.0" lineStyle="Solid" lineColor="#000000"/>
                </box>
                <textElement textAlignment="Left">
                    <font size="12"/>
                    <paragraph lineSpacing="Single"/>
                </textElement>
                <textFieldExpression><![CDATA[$V{PAGE_NUMBER} + " of "]]></textFieldExpression>
            </textField>
            <textField evaluationTime="Report" isBlankWhenNull="false">
                <reportElement key="textField" x="491" y="40" width="44" height="18"
                               uuid="36441ee7-2931-4e1d-b586-e7eb420dfbf5"/>
                <box>
                    <topPen lineWidth="0.0" lineStyle="Solid" lineColor="#000000"/>
                    <leftPen lineWidth="0.0" lineStyle="Solid" lineColor="#000000"/>
                    <bottomPen lineWidth="0.0" lineColor="#000000"/>
                    <rightPen lineWidth="0.0" lineStyle="Solid" lineColor="#000000"/>
                </box>
                <textElement textAlignment="Left">
                    <font size="12"/>
                    <paragraph lineSpacing="Single"/>
                </textElement>
                <textFieldExpression><![CDATA["" + $V{PAGE_NUMBER} + ""]]></textFieldExpression>
            </textField>
            <staticText>
                <reportElement key="staticText-5" x="376" y="40" width="81" height="18"
                               uuid="0a46e7e7-1303-4a85-977d-a45f5485b1d4">
                    <property name="local_mesure_unitheight" value="pixel"/>
                    <property name="com.jaspersoft.studio.unit.height" value="px"/>
                </reportElement>
                <box>
                    <topPen lineWidth="0.0" lineStyle="Solid" lineColor="#000000"/>
                    <leftPen lineWidth="0.0" lineStyle="Solid" lineColor="#000000"/>
                    <bottomPen lineWidth="0.0" lineColor="#000000"/>
                    <rightPen lineWidth="0.0" lineStyle="Solid" lineColor="#000000"/>
                </box>
                <textElement textAlignment="Right">
                    <font size="12"/>
                    <paragraph lineSpacing="Single"/>
                </textElement>
                <text><![CDATA[Page]]></text>
            </staticText>
            <staticText>
                <reportElement key="staticText-9" x="9" y="41" width="141" height="17"
                               uuid="8e3c4e01-0665-4643-a669-2c54eb12fae9"/>
                <box>
                    <topPen lineWidth="0.0" lineStyle="Solid" lineColor="#000000"/>
                    <leftPen lineWidth="0.0" lineStyle="Solid" lineColor="#000000"/>
                    <bottomPen lineWidth="0.0" lineStyle="Solid" lineColor="#000000"/>
                    <rightPen lineWidth="0.0" lineStyle="Solid" lineColor="#000000"/>
                </box>
                <textElement textAlignment="Right">
                    <paragraph lineSpacing="Single"/>
                </textElement>
                <text><![CDATA[Omit where no Referred By: ]]></text>
            </staticText>
            <textField isBlankWhenNull="false">
                <reportElement key="textField" x="150" y="41" width="100" height="17"
                               uuid="8ed49df8-89ce-4fad-a15c-43cdfd20e176">
                    <property name="local_mesure_unitheight" value="pixel"/>
                    <property name="com.jaspersoft.studio.unit.height" value="px"/>
                </reportElement>
                <box>
                    <topPen lineWidth="0.0" lineStyle="Solid" lineColor="#000000"/>
                    <leftPen lineWidth="0.0" lineStyle="Solid" lineColor="#000000"/>
                    <bottomPen lineWidth="0.0" lineStyle="Solid" lineColor="#000000"/>
                    <rightPen lineWidth="0.0" lineStyle="Solid" lineColor="#000000"/>
                </box>
                <textElement>
                    <paragraph lineSpacing="Single"/>
                </textElement>
                <textFieldExpression><![CDATA[$P{omitNone}]]></textFieldExpression>
            </textField>
        </band>
    </pageHeader>
    <columnHeader>
        <band height="25" splitType="Stretch">
            <staticText>
                <reportElement key="staticText-14" x="350" y="2" width="70" height="17"
                               uuid="075ce6f2-b991-4868-bab4-3b45f5113415"/>
                <box>
                    <topPen lineWidth="0.0" lineStyle="Solid" lineColor="#000000"/>
                    <leftPen lineWidth="0.0" lineStyle="Solid" lineColor="#000000"/>
                    <bottomPen lineWidth="0.0" lineColor="#000000"/>
                    <rightPen lineWidth="0.0" lineStyle="Solid" lineColor="#000000"/>
                </box>
                <textElement textAlignment="Right">
                    <font isBold="true"/>
                    <paragraph lineSpacing="Single"/>
                </textElement>
                <text><![CDATA[Total]]></text>
            </staticText>
            <line>
                <reportElement key="line-1" x="5" y="23" width="514" height="1"
                               uuid="330d43aa-22ee-4642-8365-427e98893688"/>
            </line>
            <staticText>
                <reportElement key="staticText-15" x="7" y="2" width="223" height="17"
                               uuid="135c5d9f-4a55-4722-99e7-5afcfac2e2c8"/>
                <box>
                    <topPen lineWidth="0.0" lineStyle="Solid" lineColor="#000000"/>
                    <leftPen lineWidth="0.0" lineStyle="Solid" lineColor="#000000"/>
                    <bottomPen lineWidth="0.0" lineColor="#000000"/>
                    <rightPen lineWidth="0.0" lineStyle="Solid" lineColor="#000000"/>
                </box>
                <textElement>
                    <font isBold="true"/>
                    <paragraph lineSpacing="Single"/>
                </textElement>
                <text><![CDATA[Referred By]]></text>
            </staticText>
            <staticText>
                <reportElement key="staticText-14" x="430" y="2" width="70" height="17"
                               uuid="5baf4c48-4e97-4537-b567-1e69e89a9fed">
                    <property name="local_mesure_unity" value="pixel"/>
                    <property name="com.jaspersoft.studio.unit.y" value="px"/>
                </reportElement>
                <box>
                    <topPen lineWidth="0.0" lineStyle="Solid" lineColor="#000000"/>
                    <leftPen lineWidth="0.0" lineStyle="Solid" lineColor="#000000"/>
                    <bottomPen lineWidth="0.0" lineColor="#000000"/>
                    <rightPen lineWidth="0.0" lineStyle="Solid" lineColor="#000000"/>
                </box>
                <textElement textAlignment="Right">
                    <font isBold="true"/>
                    <paragraph lineSpacing="Single"/>
                </textElement>
                <text><![CDATA[Percentage]]></text>
            </staticText>
        </band>
    </columnHeader>
    <detail>
        <band height="20" splitType="Stretch">
            <textField pattern="###0" isBlankWhenNull="false">
                <reportElement key="textField" x="350" y="2" width="70" height="13"
                               uuid="cf7c2bfd-b708-4368-811f-8790f94d6156"/>
                <box>
                    <topPen lineWidth="0.0" lineStyle="Solid" lineColor="#000000"/>
                    <leftPen lineWidth="0.0" lineStyle="Solid" lineColor="#000000"/>
                    <bottomPen lineWidth="0.0" lineColor="#000000"/>
                    <rightPen lineWidth="0.0" lineStyle="Solid" lineColor="#000000"/>
                </box>
                <textElement textAlignment="Right">
                    <paragraph lineSpacing="Single"/>
                </textElement>
                <textFieldExpression><![CDATA[$F{total}]]></textFieldExpression>
            </textField>
            <textField isBlankWhenNull="false">
                <reportElement key="textField" x="9" y="2" width="211" height="13"
                               uuid="935e4b64-1d8b-4428-93e3-619a3baf5047"/>
                <box>
                    <topPen lineWidth="0.0" lineStyle="Solid" lineColor="#000000"/>
                    <leftPen lineWidth="0.0" lineStyle="Solid" lineColor="#000000"/>
                    <bottomPen lineWidth="0.0" lineColor="#000000"/>
                    <rightPen lineWidth="0.0" lineStyle="Solid" lineColor="#000000"/>
                </box>
                <textElement>
                    <paragraph lineSpacing="Single"/>
                </textElement>
                <textFieldExpression><![CDATA[$F{Referral}]]></textFieldExpression>
            </textField>
            <textField evaluationTime="Auto" pattern="###0.0" isBlankWhenNull="false">
                <reportElement key="textField" x="430" y="2" width="70" height="13"
                               uuid="0ee3657c-51b9-428c-a2a5-0434af0ca18b">
                    <property name="local_mesure_unity" value="pixel"/>
                    <property name="com.jaspersoft.studio.unit.y" value="px"/>
                </reportElement>
                <box>
                    <topPen lineWidth="0.0" lineStyle="Solid" lineColor="#000000"/>
                    <leftPen lineWidth="0.0" lineStyle="Solid" lineColor="#000000"/>
                    <bottomPen lineWidth="0.0" lineColor="#000000"/>
                    <rightPen lineWidth="0.0" lineStyle="Solid" lineColor="#000000"/>
                </box>
                <textElement textAlignment="Right">
                    <paragraph lineSpacing="Single"/>
                </textElement>
                <textFieldExpression>
                    <![CDATA[100.0*$F{total}.floatValue()/$V{TOTAL_CUSTOMERS}.floatValue()]]></textFieldExpression>
            </textField>
        </band>
    </detail>
    <columnFooter>
        <band splitType="Stretch"/>
    </columnFooter>
    <summary>
        <band height="463" splitType="Stretch">
            <line>
                <reportElement key="line-3" x="7" y="5" width="514" height="1"
                               uuid="894efbde-19cc-4ef3-a5ef-525c414b8c64"/>
            </line>
            <staticText>
                <reportElement key="staticText-25" x="270" y="8" width="70" height="17"
                               uuid="be4a60d8-1d90-4d96-8387-144d669a30be"/>
                <box>
                    <topPen lineWidth="0.0" lineStyle="Solid" lineColor="#000000"/>
                    <leftPen lineWidth="0.0" lineStyle="Solid" lineColor="#000000"/>
                    <bottomPen lineWidth="0.0" lineColor="#000000"/>
                    <rightPen lineWidth="0.0" lineStyle="Solid" lineColor="#000000"/>
                </box>
                <textElement textAlignment="Center">
                    <font isBold="true"/>
                    <paragraph lineSpacing="Single"/>
                </textElement>
                <text><![CDATA[Total]]></text>
            </staticText>
            <textField isBlankWhenNull="false">
                <reportElement key="textField-3" x="350" y="8" width="70" height="17"
                               uuid="87c58ec7-80d2-4b9e-bab2-c2c00e3a17e3"/>
                <box>
                    <topPen lineWidth="0.0" lineStyle="Solid" lineColor="#000000"/>
                    <leftPen lineWidth="0.0" lineStyle="Solid" lineColor="#000000"/>
                    <bottomPen lineWidth="0.0" lineColor="#000000"/>
                    <rightPen lineWidth="0.0" lineStyle="Solid" lineColor="#000000"/>
                </box>
                <textElement textAlignment="Right">
                    <font size="10"/>
                    <paragraph lineSpacing="Single"/>
                </textElement>
                <textFieldExpression><![CDATA[$V{TOTAL_CUSTOMERS}]]></textFieldExpression>
            </textField>
            <pieChart>
                <chart>
                    <reportElement key="element-1" x="8" y="75" width="520" height="320"
                                   uuid="c52ef898-7dfe-4ace-ba3f-4d7b0d1ceff8"/>
                    <box>
                        <topPen lineWidth="0.0" lineStyle="Solid" lineColor="#000000"/>
                        <leftPen lineWidth="0.0" lineStyle="Solid" lineColor="#000000"/>
                        <bottomPen lineWidth="0.0" lineColor="#000000"/>
                        <rightPen lineWidth="0.0" lineStyle="Solid" lineColor="#000000"/>
                    </box>
                    <chartTitle/>
                    <chartSubtitle/>
                    <chartLegend textColor="#000000" backgroundColor="#FFFFFF"/>
                </chart>
                <pieDataset>
                    <keyExpression><![CDATA[$F{Referral}]]></keyExpression>
                    <valueExpression><![CDATA[$F{total}]]></valueExpression>
                    <labelExpression><![CDATA[$F{Referral}]]></labelExpression>
                </pieDataset>
                <piePlot isCircular="true">
                    <plot/>
                    <itemLabel color="#000000" backgroundColor="#FFFFFF"/>
                </piePlot>
            </pieChart>
            <staticText>
                <reportElement key="staticText-26" x="158" y="35" width="240" height="24"
                               uuid="e342a3d0-97f0-459c-9d29-f2289faaa2f3"/>
                <box>
                    <topPen lineWidth="0.0" lineStyle="Solid" lineColor="#000000"/>
                    <leftPen lineWidth="0.0" lineStyle="Solid" lineColor="#000000"/>
                    <bottomPen lineWidth="0.0" lineColor="#000000"/>
                    <rightPen lineWidth="0.0" lineStyle="Solid" lineColor="#000000"/>
                </box>
                <textElement>
                    <font size="18" isBold="true" isUnderline="true"/>
                    <paragraph lineSpacing="Single"/>
                </textElement>
                <text><![CDATA[Customer Referral Graph]]></text>
            </staticText>
            <staticText>
                <reportElement x="1" y="400" width="532" height="60" uuid="67f7b9d1-cbc4-413d-bb57-7738e662a24f">
                    <printWhenExpression><![CDATA[$P{Explain}]]></printWhenExpression>
                </reportElement>
                <textElement>
                    <paragraph lineSpacing="Single"/>
                </textElement>
                <text><![CDATA[This report shows the Referred By data statistics.
If the 'Omit where no Referred By' option is ticked then those customers for which there is no entry in the Referred By field are omitted. Untick this box to see what fraction of customers have no Referred By set; tick the box to see the distribition on only those customers where there is a Referred By set.]]></text>
            </staticText>
        </band>
    </summary>
</jasperReport>
