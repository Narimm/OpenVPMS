<project default="jar:jar"
         xmlns:ant="jelly:ant"
         xmlns:maven="jelly:maven"
         xmlns:j="jelly:core">

    <preGoal name="test:test">
       <attainGoal name="generate-hibernate-properties"/>
    </preGoal>

    <preGoal name="hibernate:schema-export">
        <attainGoal name="generate-hibernate-properties"/>
        <attainGoal name="extract-mapping-files"/>
    </preGoal>

    <preGoal name="hibernate:schema-update">
        <attainGoal name="generate-hibernate-properties"/>
        <attainGoal name="extract-mapping-files"/>
    </preGoal>

    <goal name="generate-hibernate-properties">
        <copy tofile="${maven.hibernate.properties}"
              file="src/test/resources/hibernate.properties">
           <filterset begintoken="${'${'}" endtoken="}">
                <filter token="hibernate.dialect" value="${hibernate.dialect}"/>
                <filter token="jdbc.driverClassName" value="${jdbc.driverClassName}"/>
                <filter token="jdbc.url" value="${jdbc.url}"/>
                <filter token="jdbc.username" value="${jdbc.username}"/>
                <filter token="jdbc.password" value="${jdbc.password}"/>
            </filterset>
        </copy>
    </goal>

    <goal name="extract-mapping-files">
        <attainGoal name="clean-mapping-files"/>

        <j:set var="repo" value="${context.getVariable('maven.repo.local')}"/>
        <j:set var="dependencyId" value="org.openvpms:openvpms-framework"/>
        <j:set var="artifactPath"
               value="${pom.getDependencyPath(dependencyId)}"/>
        <j:set var="artifactRepoPath" value="${repo}/${artifactPath}"/>

        <unzip src="${artifactPath}" dest="${maven.hibernate.input.dir}">
            <patternset>
                <include name="**/*.hbm.xml"/>
            </patternset>
        </unzip>
    </goal>

    <goal name="clean-mapping-files">
        <delete failonerror="false">
            <fileset dir="${maven.build.dir}/hibernate" includes="**/*.hbm.xml"/>
        </delete>
    </goal>

    <goal name="archetype:load" description="Load the Archetypes from a directory">
        <attainGoal name="java:compile"/>
        <attainGoal name="java:jar-resources"/>
        <attainGoal name="generate-hibernate-properties"/>
        <ant:java
                classname="org.openvpms.tools.archetype.loader.ArchetypeLoader"
                failonerror="true"
                fork="true">
            <ant:classpath>
                <ant:pathelement path="${maven.build.dest}"/>
           	    <ant:pathelement path="${maven.build.dir}/test-classes"/>
                <ant:path refid="maven.dependency.classpath"/>
            </ant:classpath>
            <arg line="${openvpms.archetype.loader.cmdline}"/>
        </ant:java>
    </goal>

    <goal name="data:load" description="Load the Archetyped Data">
        <attainGoal name="java:compile"/>
        <attainGoal name="java:jar-resources"/>
        <attainGoal name="generate-hibernate-properties"/>
        <ant:java
                classname="org.openvpms.tools.data.loader.StaxArchetypeDataLoader"
                failonerror="true"
                maxmemory="512m"
                fork="true">
            <ant:classpath>
                <ant:pathelement path="${maven.build.dest}"/>
                <ant:path refid="maven.dependency.classpath"/>
                <ant:pathelement path="${maven.build.dir}/test-classes"/>
            </ant:classpath>
            <arg line="${openvpms.data.loader.cmdline}"/>
        </ant:java>
    </goal>

    <goal name="generate-balance" description="Generate account balances">
        <attainGoal name="java:compile"/>
        <attainGoal name="java:jar-resources"/>
        <attainGoal name="generate-hibernate-properties"/>
        <ant:java
                classname="org.openvpms.archetype.tools.account.AccountBalanceTool"
                failonerror="true"
                maxmemory="512m"
                fork="true">
            <ant:classpath>
                <ant:pathelement path="${maven.build.dest}"/>
                <ant:pathelement path="${maven.build.dir}/test-classes"/>
                <ant:path refid="maven.dependency.classpath"/>
            </ant:classpath>
            <arg line="--context application-context.xml -g"/>
        </ant:java>
    </goal>

    <goal name="check-balance" description="Check account balances">
        <attainGoal name="java:compile"/>
        <attainGoal name="java:jar-resources"/>
        <attainGoal name="generate-hibernate-properties"/>
        <ant:java
                classname="org.openvpms.archetype.tools.account.AccountBalanceTool"
                failonerror="true"
                maxmemory="512m"
                fork="true">
            <ant:classpath>
                <ant:pathelement path="${maven.build.dest}"/>
                <ant:pathelement path="${maven.build.dir}/test-classes"/>
                <ant:path refid="maven.dependency.classpath"/>
            </ant:classpath>
            <arg line="--context application-context.xml -c"/>
        </ant:java>
    </goal>

    <goal name="migrate:details" description="Migrate the details column">
        <attainGoal name="java:compile"/>
        <attainGoal name="java:jar-resources"/>
        <attainGoal name="generate-hibernate-properties"/>
        <ant:java
            classname="org.openvpms.tools.data.migration.DetailsMigrator"
            failonerror="true"
        	maxmemory="512m"
            fork="true">
            <ant:classpath>
                <ant:pathelement path="${maven.build.dest}"/>
                <ant:pathelement path="${maven.build.dir}/test-classes"/>
                <ant:path refid="maven.dependency.classpath"/>
            </ant:classpath>
            <arg line="-c application-context.xml"/>
        </ant:java>
    </goal>

    <goal name="migrate:derived"
          description="Updates derived nodes">
        <attainGoal name="java:compile"/>
        <attainGoal name="java:jar-resources"/>
        <attainGoal name="generate-hibernate-properties"/>
        <ant:java
            classname="org.openvpms.tools.archetype.loader.DerivedNodeUpdater"
            failonerror="true"
            fork="true">
            <ant:classpath>
                <ant:pathelement path="${maven.build.dest}"/>
                <ant:pathelement path="${maven.build.dir}/test-classes"/>
                <ant:path refid="maven.dependency.classpath"/>
            </ant:classpath>
            <arg line="-v -a ${archetype} --context application-context.xml"/>
        </ant:java>
    </goal>

    <goal name="link-medical-records"
          description="Link medical records to act.patientClinicalEvents">
        <attainGoal name="java:compile"/>
        <attainGoal name="java:jar-resources"/>
        <attainGoal name="generate-hibernate-properties"/>
        <ant:java
            classname="org.openvpms.archetype.rules.patient.MedicalRecordActLinker"
            failonerror="true"
            fork="true">
            <ant:classpath>
                <ant:pathelement path="${maven.build.dest}"/>
                <ant:pathelement path="${maven.build.dir}/test-classes"/>
                <ant:path refid="maven.dependency.classpath"/>
            </ant:classpath>
            <arg line="-c application-context.xml"/>
        </ant:java>
    </goal>

</project>