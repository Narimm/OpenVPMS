<project default="jar:jar"
  xmlns:ant="jelly:ant"
  xmlns:maven="jelly:maven"
  xmlns:j="jelly:core"
  xmlns:castor="castor">

    <!--pregoal name="antlr:generate">
        <ant:delete dir="${maven.build.dir}/antlr"/>
    </pregoal-->

    <preGoal name="java:compile">
        <attainGoal name="castor:prepare-filesystem"/>
    	<castor:generate 
    		schema="src/java/org/openvpms/tools/security/loader/security-loader.xsd"
            package="org.openvpms.tools.security.loader"
            types="j2"/>
  	</preGoal>

    <preGoal name="test:test">
       <attainGoal name="generate-hibernate-properties"/>
    </preGoal>

    <preGoal name="hibernate:schema-export">
        <attainGoal name="java:jar-resources"/>
        <attainGoal name="generate-hibernate-properties"/>
    </preGoal>

    <preGoal name="hibernate:schema-update">
        <attainGoal name="java:jar-resources"/>
        <attainGoal name="generate-hibernate-properties"/>
    </preGoal>

    <goal name="generate-hibernate-properties">
        <copy tofile="${maven.hibernate.properties}"
              file="test/resources/hibernate.properties">
           <filterset begintoken="${'${'}" endtoken="}">
                <filter token="hibernate.dialect" value="${hibernate.dialect}"/>
                <filter token="jdbc.driverClassName" value="${jdbc.driverClassName}"/>
                <filter token="jdbc.url" value="${jdbc.url}"/>
                <filter token="jdbc.username" value="${jdbc.username}"/>
                <filter token="jdbc.password" value="${jdbc.password}"/>
            </filterset>
        </copy>
    </goal>

	<goal name="lookup:load" description="Load the Lookup Data from File">
    	<attainGoal name="java:compile"/>
	    <attainGoal name="java:jar-resources"/>
        <attainGoal name="generate-hibernate-properties"/>
	    <attainGoal name="test:test-resources"/>
		<ant:java
        	classname="org.openvpms.tools.data.loader.StaxArchetypeDataLoader"
	        failonerror="true"
	        maxmemory="512m"
    	    fork="true">
            <ant:classpath>
           		<ant:pathelement path="${maven.build.dest}"/>
           		<ant:path refid="maven.dependency.classpath"/>
           		<ant:pathelement path="${maven.build.dir}/test-classes"/>
                <ant:pathelement path="${maven.build.dir}/hibernate"/>
            </ant:classpath>
        	<arg line="${openvpms.lookup.loader.cmdline}"/>
    	</ant:java>	
    </goal>
	
	<goal name="data:load" description="Load the Archetyped Data Using STAX">
    	<attainGoal name="java:compile"/>
	    <attainGoal name="java:jar-resources"/>
        <attainGoal name="generate-hibernate-properties"/>
	    <attainGoal name="test:test-resources"/>
		<ant:java
        	classname="org.openvpms.tools.data.loader.StaxArchetypeDataLoader"
	        failonerror="true"
	        maxmemory="512m"
    	    fork="true">
            <ant:classpath>
           		<ant:pathelement path="${maven.build.dest}"/>
           		<ant:path refid="maven.dependency.classpath"/>
           		<ant:pathelement path="${maven.build.dir}/test-classes"/>
                <ant:pathelement path="${maven.build.dir}/hibernate"/>
            </ant:classpath>
        	<arg line="${openvpms.data.loader.cmdline}"/>
    	</ant:java>	
    </goal>
	
	<goal name="archetype:load" description="Load the Archetypes from a directory">
    	<attainGoal name="java:compile"/>
	    <attainGoal name="java:jar-resources"/>
        <attainGoal name="generate-hibernate-properties"/>
	    <attainGoal name="test:test-resources"/>
		<ant:java
        	classname="org.openvpms.tools.archetype.loader.ArchetypeLoader"
	        failonerror="true"
    	    fork="true">
            <ant:classpath>
           		<ant:path refid="maven.dependency.classpath"/>
           		<ant:pathelement path="${maven.build.dest}"/>
           		<ant:pathelement path="${maven.test.dest}"/>
                <ant:pathelement path="${maven.build.dir}/hibernate"/>
            </ant:classpath>
        	<arg line="${openvpms.archetype.loader.cmdline}"/>
    	</ant:java>	
    </goal>
	
	<goal name="security:load" description="Load the Security Data into the database">
    	<attainGoal name="java:compile"/>
	    <attainGoal name="java:jar-resources"/>
        <attainGoal name="generate-hibernate-properties"/>
		<ant:java
        	classname="org.openvpms.tools.security.loader.SecurityLoader"
	        failonerror="true"
    	    fork="true">
            <ant:classpath>
           		<ant:path refid="maven.dependency.classpath"/>
           		<ant:pathelement path="${maven.build.dest}"/>
                <ant:pathelement path="${maven.build.dir}/hibernate"/>
            </ant:classpath>
        	<arg line="${openvpms.security.loader.cmdline}"/>
    	</ant:java>	
    </goal>

    <goal name="migrate:details" description="Migrate the details column">
        <attainGoal name="java:compile"/>
        <attainGoal name="java:jar-resources"/>
        <attainGoal name="generate-hibernate-properties"/>
        <attainGoal name="test:test-resources"/>
        <ant:java
            classname="org.openvpms.tools.data.migration.DetailsMigrator"
            failonerror="true"
            fork="true">
            <ant:classpath>
                <ant:path refid="maven.dependency.classpath"/>
                <ant:pathelement path="${maven.build.dest}"/>
                <ant:pathelement path="${maven.test.dest}"/>
                <ant:pathelement path="${maven.build.dir}/hibernate"/>
            </ant:classpath>
            <arg line="${openvpms.migration.details.cmdline}"/>
        </ant:java>
    </goal>
</project>