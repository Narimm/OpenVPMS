<project default="jar:jar"
         xmlns:ant="jelly:ant"
         xmlns:maven="jelly:maven"
         xmlns:j="jelly:core"
         xmlns:castor="castor">

    <!-- ==================================================================== -->
    <!-- Generates java sources using castor                                  -->
    <!-- ==================================================================== -->
    <goal name="generate-castor-srcs">
      <attainGoal name="castor:prepare-filesystem"/>
      <castor:generate schema="${basedir}/src/schema/templates.xsd"
                       package="org.openvpms.report.jasper.tools"
                       types="j2"/>
    </goal>

    <!-- ==================================================================== -->
    <!-- Generates sources prior to compilation                               -->
    <!-- ==================================================================== -->
    <preGoal name="java:compile">
      <attainGoal name="generate-castor-srcs"/>
    </preGoal>

    <postGoal name="java:compile">
        <attainGoal name="generate-hibernate-properties"/>
    </postGoal>

    <goal name="generate-hibernate-properties">
        <copy tofile="${maven.build.dir}/hibernate/hibernate.properties"
              file="${basedir}/src/conf/hibernate/hibernate.properties">
            <filterset>
                <filter token="HIBERNATE_DIALECT" value="${hibernate.dialect}"/>
                <filter token="JDBC_DRIVER"
                        value="${hibernate.connection.driver_class}"/>
                <filter token="JDBC_URL" value="${hibernate.connection.url}"/>
                <filter token="JDBC_USERNAME"
                        value="${hibernate.connection.username}"/>
                <filter token="JDBC_PASSWORD"
                        value="${hibernate.connection.password}"/>
            </filterset>
        </copy>
    </goal>

    <goal name="report:load" description="Load the reports from a directory">
        <attainGoal name="java:compile"/>
        <attainGoal name="java:jar-resources"/>
        <attainGoal name="generate-hibernate-properties"/>
        <ant:java
                classname="org.openvpms.report.jasper.tools.TemplateLoader"
                failonerror="true"
                fork="true">
            <ant:classpath>
                <ant:pathelement path="${maven.build.dir}/hibernate"/>
                <ant:pathelement path="${basedir}/src/conf/spring"/>
                <ant:pathelement path="${maven.build.dest}"/>
                <ant:path refid="maven.dependency.classpath"/>
            </ant:classpath>
            <arg line="${openvpms.report.loader.cmdline}"/>
        </ant:java>
    </goal>

</project>
